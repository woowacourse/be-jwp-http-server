# 🚀 2단계 - 로그인 구현하기

# 미션 설명

서블릿을 도입해서 동적 페이지를 만들 수 있게 되었다.
이제 로그인과 회원가입 기능을 추가해보자.
로그인에 필요한 쿠키와 세션도 같이 구현해보자.

# 기능 요구 사항

## 1. HTTP Status Code 302

로그인 여부에 따라 다른 페이지로 이동시켜보자.
`/login` 페이지에서 아이디는 gugu, 비밀번호는 password를 입력하자.
로그인에 성공하면 응답 헤더에 **http status code**를 **302**로 반환하고 `/index.html`로 리다이렉트 한다.
로그인에 실패하면 `401.html`로 리다이렉트한다.

## 실행 결과

![Jun-16-2022 14-16-51.gif](https://techcourse-storage.s3.ap-northeast-2.amazonaws.com/fac9942f8feb489f89d51bc8df0765d4)

# 

## 2. POST 방식으로 회원가입

http://localhost:8080/register으로 접속하면 회원가입 페이지(register.html)를 보여준다.
회원가입 페이지를 보여줄 때는 GET을 사용한다.
회원가입을 버튼을 누르면 HTTP method를 GET이 아닌 **POST**를 사용한다.
회원가입을 완료하면 `index.html`로 리다이렉트한다.
로그인 페이지도 버튼을 눌렀을 때 GET 방식에서 POST 방식으로 전송하도록 변경하자.

## 실행 결과

![Jun-16-2022 15-55-04.gif](https://techcourse-storage.s3.ap-northeast-2.amazonaws.com/e2192f63bc394d3f95d0009e63178f71)

# 

## 3. Cookie에 JSESSIONID 값 저장하기

로그인에 성공하면 쿠키와 세션을 활용해서 로그인 상태를 유지해야 한다.
HTTP 서버는 세션을 사용해서 서버에 로그인 여부를 저장한다.
세션을 구현하기 전에 먼저 쿠키를 구현해본다.

자바 진영에서 세션 아이디를 전달하는 이름으로 `JSESSIONID`를 사용한다.

서버에서 HTTP 응답을 전달할 때 응답 헤더에 `Set-Cookie`를 추가하고 `JSESSIONID=656cef62-e3c4-40bc-a8df-94732920ed46` 형태로 값을 전달하면 클라이언트 요청 헤더의 `Cookie` 필드에 값이 추가된다.

서버로부터 쿠키 설정된 클라이언트의 HTTP Request Header 예시

```plaintext
GET /index.html HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Accept: */*
Cookie: yummy_cookie=choco; tasty_cookie=strawberry; JSESSIONID=656cef62-e3c4-40bc-a8df-94732920ed46
```

Cookie 클래스를 추가하고 HTTP Request Header의 Cookie에 `JSESSIONID`가 없으면 HTTP Response Header에 `Set-Cookie`를 반환해주는 기능을 구현한다.

```plaintext
HTTP/1.1 200 OK 
Set-Cookie: JSESSIONID=656cef62-e3c4-40bc-a8df-94732920ed46
Content-Length: 5571
Content-Type: text/html;charset=utf-8;
```

## 실행 결과

![Jun-16-2022 17-18-10.gif](https://techcourse-storage.s3.ap-northeast-2.amazonaws.com/3129af4863e34556b6bc73ac63bb6bc0)

# 

## 4. Session 구현하기

쿠키에서 전달 받은 `JSESSIONID`의 값으로 로그인 여부를 체크할 수 있어야 한다.
로그인에 성공하면 Session 객체의 값으로 `User` 객체를 저장해보자.

그리고 로그인된 상태에서 `/login` 페이지에 HTTP GET method로 접근하면 이미 로그인한 상태니 `index.html` 페이지로 리다이렉트 처리한다.

# 체크리스트

- HTTP Reponse의 상태 응답 코드를 302로 반환한다.
- POST로 들어온 요청의 Request Body를 파싱할 수 있다.
- 로그인에 성공하면 HTTP Reponse의 헤더에 Set-Cookie가 존재한다.
- 서버에 세션을 관리하는 클래스가 있고, 쿠키로부터 전달 받은 JSESSIONID 값이 저장된다.

# 힌트

## 1. HTTP Status Code 302

[Mozilla 문서](https://developer.mozilla.org/ko/docs/Web/HTTP/Status/302)를 참고해서 HTTP Response를 수정해보자.

## 2. POST 방식으로 회원가입

브라우저에서 HTTP 요청을 다음과 같이 보낸다.

```plaintext
POST /register HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Content-Length: 80
Content-Type: application/x-www-form-urlencoded
Accept: */*

account=gugu&password=password&email=hkkang%40woowahan.com
```

1. while 문으로 http request header를 읽고 나서 request body를 읽어온다.
   - request header의 **Content-Length**가 request body의 length다.

```java
int contentLength = Integer.parseInt(httpRequestHeaders.get("Content-Length"));
char[] buffer = new char[contentLength];
reader.read(buffer, 0, contentLength);
String requestBody = new String(buffer);
```

1. **POST**로 전달하면 GET과 다르게 `http request body`에 데이터가 담긴다.
2. `login.html`도 form 태그를 수정한다.
3. InMemoryUserRepository에서 save 메서드를 사용해서 가입 완료 처리한다.
4. 이상 없으면 리다이렉트

## 3. Cookie에 JSESSIONID 값 저장하기

자바에서 UUID 클래스를 사용하면 고유한 아이디를 만들 수 있다.

```java
UUID uuid = UUID.randomUUID();
public class HttpCookie {
    ...
    // 아래와 같은 쿠키 값을 파싱해서 map으로 저장한다.
    // yummy_cookie=choco; tasty_cookie=strawberry; JSESSIONID=656cef62-e3c4-40bc-a8df-94732920ed46
}
```

## 4. Session 구현하기

모든 클라이언트의 세션 값을 관리하는 클래스를 추가한다.
각 세션의 id는 `uuid`를 사용한다

```java
...
import org.apache.catalina.Manager;
...
public class SessionManager implements Manager {

    // static!
    private static final Map<String, Session> SESSIONS = new HashMap<>();

    @Override
    public void add(final Session session) {
        ...
    }

    @Override
    public Session findSession(final String id) {
        ...
    }

    @Override
    public void remove(final String id) {
        ...
    }

    private SessionManager() {}
}
```

클라이언트별 세션 데이터를 관리하는 세션 클래스를 추가한다.

```java
public class Session {

    private final String id;
    private final Map<String, Object> values = new HashMap<>();

    public Session(final String id) {
        ...
    }

    public String getId() {
        ...
    }

    public Object getAttribute(final String name) {
        ...
    }

    public void setAttribute(final String name, final Object value) {
        ...
    }

    public void removeAttribute(final String name) {
        ...
    }

    public void invalidate() {
        ...
    }
}
```

로그인을 구현할 때 참고한다.

```java
if (user.checkPassword(password)) {
    final var session = request.getSession(true);
    session.setAttribute("user", user);
    response.addCookie(Cookies.ofJSessionId(session.getId()));
    response.sendRedirect("/index.html");
    return;
}
    private User getUser(Session session) {
        return (User) session.getAttribute("user");
    }
```